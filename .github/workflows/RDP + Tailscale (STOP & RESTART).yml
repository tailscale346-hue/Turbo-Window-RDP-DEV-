name: RDP + Tailscale (STOP & RESTART)

on:
  workflow_dispatch:
    inputs:
      cycles_left: { description: "Cycles remaining", required: true }

permissions:
  contents: read
  actions: write

defaults:
  run:
    shell: pwsh

jobs:
  stop-and-restart:
    runs-on: ubuntu-latest

    steps:
      - name: Purge bullet devices
        run: |
          try{
            $auth=[Convert]::ToBase64String([Text.Encoding]::ASCII.GetBytes("${{ secrets.TS_API_KEY }}:"))
            $tn=[uri]::EscapeDataString("${{ vars.TS_TAILNET }}")

            $list=Invoke-RestMethod "https://api.tailscale.com/api/v2/tailnet/$tn/devices" -Headers @{Authorization="Basic $auth"}
            $count=0
            foreach($d in $list.devices){
              if($d.hostname -match '^bullet[12]'){
                Invoke-RestMethod -Method Delete -Uri "https://api.tailscale.com/api/v2/device/$($d.id)" -Headers @{Authorization="Basic $auth"} -ErrorAction SilentlyContinue
                $count++
              }
            }
            Write-Host "üßπ Removed $count bullet devices."
          }catch{
            Write-Host "‚ö†Ô∏è Cleanup failed: $($_.Exception.Message)"
          }

      - name: Decide next step
        id: next
        run: |
          $left=[int]"${{ inputs.cycles_left }}"
          if($left -le 0){
            "RESTART=0" | Out-File -Append $env:GITHUB_ENV
          }else{
            "RESTART=1" | Out-File -Append $env:GITHUB_ENV
          }

      - name: Wait 20 minutes
        if: env.RESTART == '1'
        run: |
          $end=(Get-Date).AddMinutes(20)
          while((Get-Date) -lt $end){
            Write-Host ("‚è≥ Cooling "+(Get-Date))
            Start-Sleep 60
          }

      - name: Restart Workflow 1
        if: env.RESTART == '1'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          $next=[int]"${{ inputs.cycles_left }}" - 1

          if($next -le 0){
            Write-Host "‚úÖ All cycles complete."
            exit 0
          }

          $payload=@{
            cycles_left="$next"
            runtime_minutes="${{ vars.DEFAULT_RUNTIME }}"
            rdp_count="${{ vars.DEFAULT_RDP_COUNT }}"
            quick_test="false"
          }

          $url="https://api.github.com/repos/${{ github.repository }}/actions/workflows/workflow-1.yml/dispatches"
          $hdr=@{Authorization="Bearer $env:GH_TOKEN";Accept="application/vnd.github+json"}
          $body=@{ref="${{ github.ref_name }}";inputs=$payload} | ConvertTo-Json -Depth 20

          Invoke-WebRequest -Method POST -Uri $url -Headers $hdr -Body $body | Out-Null
          Write-Host "üöÄ Restarted Workflow 1 (cycles left: $next)"
